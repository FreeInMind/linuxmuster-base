# start postgresql
/etc/init.d/postgresql start

# set samba sid
[ -n "$sambasid" ] && net setlocalsid $sambasid

# patch libnss-ldap.conf with basedn
template=/etc/libnss-ldap.conf
sed -e "s/^base.*/base $basedn/
        s/^rootbinddn.*/rootbinddn cn=admin,$basedn/" $template > ${template}.tmp
mv ${template}.tmp $template

# patch pam_ldap.conf with basedn
template=/etc/pam_ldap.conf
sed -e "s/^base.*/base $basedn/
        s/^rootbinddn.*/rootbinddn cn=admin,$basedn/" $template > ${template}.tmp
mv ${template}.tmp $template

# patch ldap.conf with basedn
template=/etc/ldap/ldap.conf
sed -e "s/^BASE.*/BASE $basedn/" $template > ${template}.tmp
mv ${template}.tmp $template

# patch slapd.conf with basedn
template=/etc/ldap/slapd.conf
sed -e "s/by dn=\"cn=admin.*/by dn=\"cn=admin,$basedn\" write/g
        s/^suffix.*/suffix          \"$basedn\"/
        s/^rootdn.*/rootdn          \"cn=admin,$basedn\"/" $template > ${template}.tmp
mv ${template}.tmp $template

# patch smbldap_bind.conf with basedn
template=/etc/smbldap-tools/smbldap_bind.conf
sed -e "s/^masterDN=.*/masterDN=\"cn=admin,$basedn\"/" $template > ${template}.tmp
mv ${template}.tmp $template

# patching sophomorix.conf with schoolname, location and servername
sed -e "s/^\$schul_name=.*/\$schul_name=\"${schoolname} ${location}\";/
        s/^\$smb_netbios_name =.*/\$smb_netbios_name = \"${servername}\";/" $SOPHOMORIXCONF > $SOPHOMORIXCONF.tmp
mv $SOPHOMORIXCONF.tmp $SOPHOMORIXCONF

# patch sophomorix pgldap.conf with workgroup, server, internip and domainname
template=/etc/sophomorix/pgldap/pgldap.conf
sed -e "s/^\$domainname=.*/\$domainname=\"${domainname}\";/
        s/^\$servername=.*/\$servername=\"${servername}\";/
        s/^\$internip=.*/\$internip=\"${serverip}\";/
        s/^\$smbworkgroup=.*/\$smbworkgroup=\"${workgroup}\";/" $template > ${template}.tmp
mv ${template}.tmp $template

# patch sophomorix slapd template with current sid & samba domain
template=/usr/share/sophomorix/config-templates/ldap/slapd-standalone.conf.template
sed -e "s/^sambaSID:.*/sambaSID: $sambasid/
        s/^sambaDomainName:.*/sambaDomainName: $workgroup/
        s/by \* none/by \* read/g" $template > ${template}.tmp
mv ${template}.tmp $template

# clear samba browse cache
rm -f /var/lib/samba/wins.dat

# only on fresh install
if [ "$1" = "--first" ]; then

  # delete old userdata
  [[ -n "$ADMINSHOME" && -d "$ADMINSHOME" ]] && rm -rf $ADMINSHOME/*
  [[ -n "$TEACHERSHOME" && -d "$TEACHERSHOME" ]] && rm -rf $TEACHERSHOME/*
  [[ -n "$STUDENTSHOME" && -d "$STUDENTSHOME" ]] && rm -rf $STUDENTSHOME/*
  [[ -n "$WSHOME" && -d "$WSHOME" ]] && rm -rf $WSHOME/*
  [[ -n "$SHAREHOME" && -d "$SHAREHOME" ]] && rm -rf $SHAREHOME/*/*
  [[ -n "$TASKSCACHE" && -d "$TASKSCACHE" ]] && rm -rf $TASKSCACHE/*/*
  rm -rf /var/lib/sophomorix/check-result/*
  rm -rf /var/lib/sophomorix/database/*
  rm -rf /var/lib/sophomorix/tmp/*
  rm -rf /var/lib/sophomorix/print-data/*
  rm -rf /var/log/sophomorix/*.log
  rm -rf /var/log/sophomorix/exam/*
  rm -rf /var/log/sophomorix/user/*

  # changing user's default shell to /bin/bash
  sed -e 's/^\$schueler_per_ssh=.*/\$schueler_per_ssh=\"yes\"\;/
          s/^\$lehrer_per_ssh=.*/\$lehrer_per_ssh=\"yes\"\;/' $SOPHOMORIXCONF > $SOPHOMORIXCONF.tmp
  mv $SOPHOMORIXCONF.tmp $SOPHOMORIXCONF

  # create new database
  sophomorix-setup-pgldap --new-database

else

  # update user database with basedn and workgroup if necessary
  sophomorix-setup-pgldap
  
fi

# repair permissions
for i in /etc/ldap.secret /etc/ldap/slapd.conf /etc/smbldap-tools/smbldap_bind.conf /etc/sophomorix/pgldap/pgldap.conf; do
  chmod 600 $i
done

chown www-data:www-data /etc/linuxmuster/schulkonsole/*
chmod 400 /etc/linuxmuster/schulkonsole/db.conf*
chown root:root /etc/ldap/slapd.conf*
chown root:root /etc/ldap/ldap.conf
chmod 644 /etc/ldap/ldap.conf

